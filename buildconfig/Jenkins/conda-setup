#!/bin/bash -ex

# From https://stackoverflow.com/a/9107028 by https://stackoverflow.com/users/1184238/andrew-norrie
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

EXPECTED_MINICONDA_DIR_PATH=$HOME/miniconda3
EXPECTED_CONDA_PATH=$EXPECTED_MINICONDA_DIR_PATH/bin/conda

# Ensure conda is installed
if [[ ! -f $EXPECTED_CONDA_PATH ]]; then
    if [[ ! -f Miniconda3-latest-Linux-x86_64.sh ]]; then
        # Download miniconda
        curl -O https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    fi
    sh Miniconda3-latest-Linux-x86_64.sh -b -p $EXPECTED_MINICONDA_DIR_PATH
    rm Miniconda3-latest-Linux-x86_64.sh
fi

# With miniconda we can grab the mantid environment if it doesn't already exist
ENVS=$($EXPECTED_CONDA_PATH env list)
if [[ ! $ENVS = *"$EXPECTED_MINICONDA_DIR_PATH/envs/mantid"* ]]; then
    # THIS IS JUST A TEST PATH:
    $EXPECTED_CONDA_PATH env create -f $SCRIPT_DIR/../../mantid-developer-linux.yml
else
    echo "Conda environment already setup."
fi

echo "Conda is now configured, and setup."
exit